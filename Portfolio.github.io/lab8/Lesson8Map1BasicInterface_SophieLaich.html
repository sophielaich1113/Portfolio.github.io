<!DOCTYPE html>
<html>
<head>
<meta charset = "utf-8">
<meta name = "viewport" content  = "initial-scale = 1, maximum-scale=1, user-scalable=no">
<title>Load a basic WebMap</title>

<style>
html, 
body,
#viewDiv {
padding:0;
margin: 0;
height: 100%;
width: 100%;
}
#overviewDiv {
position: absolute;
top: 12px;
right: 12px;
width: 200px;
height: 150px;
border: 1px solid black;
z-index: 1;
}
#extentDiv {
border: 2px solid red;
position: absolute;
z-index: 2;
}
</style>

<link rel="stylesheet" href="https://js.arcgis.com/4.34/esri/css/main.css">
<script src="https://js.arcgis.com/4.34/"></script>

<script>
	require ([
	"esri/core/urlUtils",
	"esri/layers/WebTileLayer",
	"esri/Map",
	"esri/Basemap",
	"esri/views/MapView",
	"esri/layers/FeatureLayer",
	"esri/layers/CSVLayer",
	"esri/widgets/Legend",
	"esri/widgets/Search",
	"esri/widgets/LayerList",
	"esri/Graphic",
	"esri/core/reactiveUtils",
	"esri/core/promiseUtils"
	], function (
	
	urlUtils, WebTileLayer, Map, Basemap, MapView, FeatureLayer, CSVLayer, Legend, Search, LayerList, Graphic, reactiveUtils, promiseUtils
	){

	var thunderForest = new WebTileLayer ({
		urlTemplate: "https://tile.thunderforest.com/landscape/{level}/{col}/{row}.png?apikey=3382147cd19d4c148bac746589964ab5",
		subDomains: ["a","b","c"]
	});

	var mybasemap = new Basemap ({
		baseLayers: [thunderForest]
	});

	var mymap = new Map ({
		basemap: mybasemap,
	});

	var myview = new MapView({
		map: mymap,
		container: "viewDiv",
		center:[-115.5, 45],
		extent:{
			xmin: -101,
			ymin: 34,
			xmax: -132, 
			ymax: 49.5,
			spatialReference: 4326
		}
	});

	var counties = new FeatureLayer({
		portalItem: { id: "5fb6ebf9392647ccb78447b9c11cbdde" }
	});
	mymap.add(counties);

	var cities = new FeatureLayer({
		portalItem: { id: "ad15f041abe14e3293711070f7cd94f8" }
	});
	mymap.add(cities);

	var roadSystem = new FeatureLayer ({
		url: "https://carto.nationalmap.gov/arcgis/rest/services/transportation/MapServer/8"
	});
	mymap.add(roadSystem);

	var template = {
		title: "Earthquake Info",
		content: "Magnitude {mag} {type} hit {place} on {time}."
	};

	var earthquakes = new CSVLayer({
		url: "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.csv",
		latitudeField: "latitude",
		longitudeField: "longitude",
		copyright: "USGS Earthquakes",
		popupTemplate: template
	});

	earthquakes.renderer = {
		type: "simple",
		symbol: {
			type: "simple-marker",
			color: "#621900",
			size: 10,
			outline: {
				width: 0.5,
				color: "white"
			}
		}
	};
	mymap.add(earthquakes);

	var earthquakesDropbox = new CSVLayer({
		url: "https://cors-anywhere.herokuapp.com/https://www.dropbox.com/scl/fi/u0hzg331ng0mpov1ikjas/all_hour.csv?dl=1",
		copyright: "USGS Earthquakes",
		popupTemplate: template
	});

	earthquakesDropbox.renderer = {
		type: "simple",
		symbol: {
			type: "simple-marker",
			color: "#ff7f00",
			size: 10,
			outline: {
				width: 0.5,
				color: "white"
			}
		}
	};
	mymap.add(earthquakesDropbox);
	
	var myLegend = new Legend({
	view: myview,
	layerInfos: [{
	layer: counties,
	title: "Population"
	},{
	layer: cities,
	title: "Cities"
	},{
	layer: roadSystem,
	title: "Roads"
	},{
	layer: earthquakes,
	title: "USGS earthquakes feed"
	},{
	layer: earthquakesDropbox,
	title: "USGS earthquakes, Dropbox feed"
	}]
	});
	myview.ui.add(myLegend, "bottom-left");
	
	var searchWidget = new Search ({
	view: myview
	});
	
	myview.ui.add(searchWidget, {
	position: "top-left",
	index: -2});
	
	myview.when(function(){
	var layerslisted = new LayerList({
	view: myview,
	});
	myview.ui.add(layerslisted,{position:"bottom-right"});
});
	
	
	var overviewmap = new Map ({
	basemap: "topo-vector"
	});
	
	var smallview = new MapView({
	container: "overviewDiv",
	map: overviewmap,
	constraints: {
		rotationEnabled: false
		}
	});
	
	smallview.ui.components = [];
	
	smallview.when(() => {
	myview.when(() => {
	setup();
	});
});


const extentDebouncer = promiseUtils.debounce(() => {
if (myview.stationary) {
smallview.goTo({
center: myview.center,
scale:
myview.scale *
2 *
Math.max(
myview.width / smallview.width,
myview.height / smallview.height
)
});
}
});


function setup() {
const extentgraphic = new Graphic({
geometry: null,
symbol: {
type: "simple-fill",
style: "none",
color: "none",
outline: {
width: 1,
color: "#FF0055",
style: "solid"
}
}
});
smallview.graphics.add(extentgraphic);

reactiveUtils.watch(
() => myview.extent,
(extent) => {


extentDebouncer().then(() => {
extentgraphic.geometry = extent;
});
},
{
initial: true
}
);
}

});
</script>
</head>

<body>
<div  id="viewDiv"></div>
<div id = "overviewDiv">
</div>
</body>

</html>
